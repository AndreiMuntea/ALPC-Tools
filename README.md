
## About
This project contains a part of the work I did for my Master's thesis. It has been rewritten to use the xplatform library.
It uses manually crafted ALPC calls to existing RPC servers and to documented (and undocumented) methods. It has a minimalistic implementation of DCE (both NDR  and NDR64) serialization protocol (basically I implemented what was required for my needs). It includes the monitoring solution on how we can intercept the messages between two processes based on API hooking.

It contains some simple commands such as:
 - RunTask       - Uses a call to SchRpcRun() to run an existing task;
 - ClearEventLog - Uses EvtRpcClearLog() to erase the event logs;
 - DeleteFwRules - Uses FWDeleteAllFirewallRules() to remove the firewall rules;
 - CreateService - Uses RCreateServiceW() to create a kernel mode service;
 - CreateUser    - Uses SamrCreateUser2InDomain() to create a new user;

As stated above, this was the work I did for my Master's thesis, and it was presented at an academic conference as well. If you find it useful, please cite it with:
```
@INPROCEEDINGS{10554183,
  author={Andrei-Marius, Muntea and Radu-Marian, Portase and Gheorghe, Sebestyen-Pal},
  booktitle={2024 IEEE International Conference on Automation, Quality and Testing, Robotics (AQTR)}, 
  title={Monitoring of RPC Messages with ALPC-Level API Hooking}, 
  year={2024},
  volume={},
  number={},
  pages={1-6},
  doi={10.1109/AQTR61889.2024.10554183}}
```

## References
Great materials I found online and I used when doing the work on this project:
 - WINDOWS PRIVILEGE ESCALATION THROUGH LPC AND ALPC INTERFACES (Thomas Garnier)
 - All about the ALPC, RPC, LPC, LRPC in your PC (SysCan 2014 - Alex Ionescu)
 - https://pubs.opengroup.org/onlinepubs/9629399/chap14.htm 

Also great tools to extract existing interfaces:
 - RpcView https://github.com/silverf0x/RpcView
 - WindowsRpcClients https://github.com/tyranid/WindowsRpcClients

## Documentation
Documentation can be autogenerated with Doxygen. The DoxyFile is included in the project.
The actual documentation is not included. It will be dropped inside the "out/Doxygen" directory.

## Functionality
 - Alpc-Demo is a user mode application which has the purpose of demonstrating how RPC calls can be performed manually with ALPC protocol
 - AlpcMon_Dll is a user mode dll which is part of the monitoring solution, this is injected by the driver and detours the NtAlpc* APIs. It then sends the message buffer to KM for further inspection.
 - AlpcMon_Sys is a kernel mode driver which injects the dll and inspects the messages. Currently it just logs the relevant content.
 - Alpc-Installer is a separated project which builds an executable capable of installing the driver solution, dropping the dlls and doing uninstall cleanup when analysis is completed. It is not included in the main solution as it is only an ease-of-life project. Can be built independently.

## Build & Install
 - I used Visual Studio 2019 with its corresponding WDK and SDK for driver build. (Did not use 2022 because the support for x86 and for older OSes like windows 7 was dropped. I still like backward compatibility so I went for 2019.) Should be easy enough to change for 2022.
 - You can download the older sdks and wdks from here: https://learn.microsoft.com/en-us/windows-hardware/drivers/other-wdk-downloads I recommend version 1903.
 - After evertyhing is in place, you can simply build from the visual studio.
 - To run the solution you need a virtual machine as the driver is not signed. Don't forget to run:
 ```
  bcdedit.exe -set loadoptions DDISABLE_INTEGRITY_CHECKS
  bcdedit.exe -set TESTSIGNING ON
 ```
 - I highly recommend attaching a kernel debugger and monitor any system crashes which may occur. Please report any bugs you encounter. I am happy to fix them.

## License
Please see the LICENSE file.
